"use strict";module.exports=function(r){require("source-map-support").install();var d=require("./core/opcua-iiot-core-browser");r.nodes.registerType("OPCUA-IIoT-Browser",function(e){r.nodes.createNode(this,e),this.nodeId=e.nodeId,this.name=e.name,this.justValue=e.justValue,this.sendNodesToRead=e.sendNodesToRead,this.sendNodesToBrowser=e.sendNodesToBrowser,this.sendNodesToListener=e.sendNodesToListener,this.singleBrowseResult=e.singleBrowseResult,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.recursiveBrowse=e.recursiveBrowse,this.recursiveDepth=e.recursiveDepth||1,this.delayPerMessage=e.delayPerMessage||.2,this.connector=r.nodes.getNode(e.connector);var c=d.initBrowserNode(this);d.core.assert(c.bianco.iiot),c.bianco.iiot.delayMessageTimer=[],c.bianco.iiot.extractDataFromBrowserResults=function(e,o){o.addressItemList=[],e&&e.length&&(e.forEach(function(e){e&&e.length&&e.forEach(function(e){e.references.forEach(function(e){d.detailDebugLog("Add Reference To List :"+e),o.browserResults.push(d.transformToEntry(e)),e.nodeId&&(o.nodesToRead.push(e.nodeId.toString()),o.addressItemList.push({nodeId:e.nodeId.toString(),browseName:e.browseName.toString(),displayName:e.displayName.toString(),nodeClass:e.nodeClass.toString(),datatypeName:e.typeDefinition.toString()}))})})}),o.addressSpaceItemList=o.addressSpaceItemList.concat(o.addressItemList))},c.bianco.iiot.browse=function(t,i,r,n,a){if(!d.core.checkSessionNotValid(c.bianco.iiot.opcuaSession,"Browse")){d.internalDebugLog("Browse Topic To Call Browse "+t);d.browse(c.bianco.iiot.opcuaSession,t).then(function(e){if(e&&e.length)if(d.detailDebugLog("Browser Results Count: "+e.length),c.bianco.iiot.extractDataFromBrowserResults(e,n),c.recursiveBrowse)if(0<r){var o=r-1,s=c.bianco.iiot.createListsObject();c.singleBrowseResult?s=n:a("list",r,i,n),c.bianco.iiot.browseNodeList(n.addressItemList,i,o,s,a)}else d.internalDebugLog("Minimum Depth Reached On Browse At "+t),a(t,r,i,n);else a(t,r,i,n);else d.internalDebugLog("No Browse Results On "+t)}).catch(function(e){d.browseErrorHandling(c,e,i,n)})}},c.bianco.iiot.createListsObject=function(){return{nodesToBrowse:[],nodesToRead:[],addressItemList:[],addressSpaceItemList:[],browserResults:[]}},c.bianco.iiot.browseNodeList=function(e,t,i,r,n){if(!d.core.checkSessionNotValid(c.bianco.iiot.opcuaSession,"BrowseList")){d.internalDebugLog("Browse For NodeId List");var a="list";c.bianco.iiot.opcuaSession&&d.browseAddressSpaceItems(c.bianco.iiot.opcuaSession,e).then(function(e){if(d.detailDebugLog("List Browser Result To String: "+e.toString()),c.bianco.iiot.extractDataFromBrowserResults(e,r),c.recursiveBrowse)if(0<i){var o=i-1,s=c.bianco.iiot.createListsObject();c.singleBrowseResult?s=r:n(a,i,t,r),c.bianco.iiot.browseNodeList(r.addressItemList,t,o,s,n)}else d.internalDebugLog("Minimum Depth Reached On Browse List"),n(a,i,t,r);else n(a,i,t,r)}).catch(function(e){d.browseErrorHandling(c,e,t,r)})}},c.bianco.iiot.sendMessage=function(e,o,s,t){var i=Object.assign({},s);i.nodetype="browse",i.justValue=c.justValue,t||(d.internalDebugLog("Lists Not Valid!"),c.showErrors&&c.error(new Error("Lists Not Valid On Browse Send Message"),i));var r=c.bianco.iiot.getListenParameters(i);i.payload={rootNodeId:e,browserResults:t.browserResults,recursiveBrowse:c.recursiveBrowse,recursiveDepth:o,recursiveDepthMax:c.recursiveDepth,listenerParameters:r},i=c.bianco.iiot.enhanceMessage(i,t),i=c.bianco.iiot.setMessageLists(i,t),c.bianco.iiot.messageList.push(i),c.showStatusActivities&&"active"!==c.status.text&&d.core.setNodeStatusTo(c,"active"),c.bianco.iiot.delayMessageTimer.push(setTimeout(function(){c.send(c.bianco.iiot.messageList.shift())},c.delayPerMessage*d.core.FAKTOR_SEC_TO_MSEC))},c.bianco.iiot.resetAllTimer=function(){c.bianco.iiot.delayMessageTimer.forEach(function(e){clearTimeout(e),e=null})},c.bianco.iiot.getListenParameters=function(e){return"listen"===e.injectType?e.payload:null},c.bianco.iiot.enhanceMessage=function(e,o){return c.justValue?e.payload.browserResults=o.addressSpaceItemList:(e.payload.browseTopic=c.browseTopic,e.payload.addressSpaceItems=e.addressSpaceItems,e.payload.browserResultsCount=o.browserResults.length,c.connector&&(e.payload.endpoint=c.connector.endpoint),e.payload.session=c.bianco.iiot.opcuaSession?c.bianco.iiot.opcuaSession.name:"none"),e},c.bianco.iiot.setMessageLists=function(e,o){return c.sendNodesToRead&&o.nodesToRead&&(e.nodesToRead=o.nodesToRead,e.nodesToReadCount=o.nodesToRead.length),c.sendNodesToListener&&o.addressSpaceItemList&&(e.addressItemsToRead=o.addressSpaceItemList,e.addressItemsToReadCount=o.addressSpaceItemList.length),c.sendNodesToBrowser&&o.addressSpaceItemList&&(e.addressItemsToBrowse=o.addressSpaceItemList,e.addressItemsToBrowseCount=o.addressSpaceItemList.length),e},c.bianco.iiot.browseSendResult=function(e,o,s,t){d.internalDebugLog(e+" called by depth "+o),c.singleBrowseResult?o<=0&&(c.bianco.iiot.sendMessage(e,o,s,t),c.bianco.iiot.reset(t)):(c.bianco.iiot.sendMessage(e,o,s,t),c.bianco.iiot.reset(t))},c.bianco.iiot.reset=function(e){c.bianco.iiot.createListsObject()},c.bianco.iiot.browseWithAddressSpaceItems=function(e,o,s){e.addressItemsToBrowse&&0<e.addressItemsToBrowse.length&&(e.addressSpaceItems=e.addressItemsToBrowse),e.addressSpaceItems&&0<e.addressSpaceItems.length?c.bianco.iiot.browseNodeList(e.addressSpaceItems,e,o,s,function(e,o,s,t){c.bianco.iiot.browseSendResult(e,o,s,t)}):(d.detailDebugLog("Fallback NodeId On Browse Without AddressSpace Items"),c.browseTopic=c.nodeId||d.browseToRoot(),c.bianco.iiot.browse(c.browseTopic,e,o,s,function(e,o,s,t){c.bianco.iiot.browseSendResult(e,o,s,t)}))},c.bianco.iiot.startBrowser=function(e){if(!d.core.checkSessionNotValid(c.bianco.iiot.opcuaSession,"Browser")){var o=c.bianco.iiot.createListsObject(),s=c.recursiveBrowse?c.recursiveDepth:0;c.browseTopic=d.extractNodeIdFromTopic(e,c),c.browseTopic&&""!==c.browseTopic?c.bianco.iiot.browse(c.browseTopic,e,s,o,function(e,o,s,t){c.bianco.iiot.browseSendResult(e,o,s,t)}):c.bianco.iiot.browseWithAddressSpaceItems(e,s,o)}},c.on("input",function(e){d.core.checkConnectorState(c,e,"Browser")&&(c.showStatusActivities&&d.core.setNodeStatusTo(c,"browsing"),c.bianco.iiot.startBrowser(e))}),d.core.registerToConnector(c),c.on("close",function(e){d.core.deregisterToConnector(c,function(){d.core.resetBiancoNode(c),e()})})}),r.httpAdmin.get("/opcuaIIoT/browse/:id/:nodeId",r.auth.needsPermission("opcuaIIoT.browse"),function(e,o){var s=r.nodes.getNode(e.params.id),t=[],i=decodeURIComponent(e.params.nodeId)||d.core.OBJECTS_ROOT;d.detailDebugLog("request for "+e.params.nodeId),s.bianco.iiot.opcuaSession?d.browse(s.bianco.iiot.opcuaSession,i).then(function(e){e.forEach(function(e){e.forEach(function(e){e.references&&e.references.length&&e.references.forEach(function(e){t.push(d.transformToEntry(e))})})}),o.json(t)}).catch(function(e){d.internalDebugLog("Browser Error "+e),s.showErrors&&s.error(e,{payload:"Browse Internal Error"}),t.push({displayName:{text:"Objects"},nodeId:d.core.OBJECTS_ROOT,browseName:"Objects"}),o.json(t)}):o.json(t)})};
//# sourceMappingURL=maps/opcua-iiot-browser.js.map
