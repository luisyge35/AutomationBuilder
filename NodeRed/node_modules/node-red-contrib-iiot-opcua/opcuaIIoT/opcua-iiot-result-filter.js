"use strict";module.exports=function(t){require("source-map-support").install();var a=require("./core/opcua-iiot-core-filter"),o=require("underscore");t.nodes.registerType("OPCUA-IIoT-Result-Filter",function(e){t.nodes.createNode(this,e),this.nodeId=e.nodeId,this.datatype=e.datatype,this.fixedValue=e.fixedValue,this.fixPoint=2|parseInt(e.fixPoint),this.withPrecision=e.withPrecision,this.precision=2|parseInt(e.precision),this.entry=e.entry||1,this.justValue=e.justValue,this.withValueCheck=e.withValueCheck,this.minvalue=e.minvalue,this.maxvalue=e.maxvalue,this.defaultvalue=e.defaultvalue,this.topic=e.topic,this.name=e.name,this.showErrors=e.showErrors;var r=this;r.bianco=a.core.createBiancoIIoT(),a.core.assert(r.bianco.iiot),r.status({fill:"blue",shape:"ring",text:"new"}),r.bianco.iiot.nodeIdToFilter=function(e){var t=!0,o=a.core.buildNodeListFromClient(e);return o&&o.length&&(t=!o.some(function(e,t,o){return(e.nodeId||e).toString()===r.nodeId.toString()})),t},r.bianco.iiot.isNodeIdNotToFindInAddressSpaceItems=function(e){if(e.addressSpaceItems){if(o.filter(e.addressSpaceItems,function(e){return e.nodeId===r.nodeId}).length<1)return!0}else if(e.topic!==r.nodeId)return!0},r.bianco.iiot.messageIsToFilter=function(e){return r.bianco.iiot.nodeIdToFilter(e)&&r.bianco.iiot.isNodeIdNotToFindInAddressSpaceItems(e)},r.on("input",function(e){if(e.hasOwnProperty("payload")&&null!==e.payload&&void 0!==e.payload)if(r.bianco.iiot.messageIsToFilter(e))a.internalDebugLog("filtering message on filter");else{var t=Object.assign({},e);t.topic=r.topic||t.topic,t.nodeId=r.nodeId,t.justValue=r.justValue,t.filter=!0,t.filtertype="filter",t.payload=r.bianco.iiot.filterByType(t)||t.payload,r.justValue&&(t.payload=r.bianco.iiot.filterResult(t)),a.core.assert(t.payload),r.send(t)}else a.internalDebugLog("filtering message without payload")}),r.bianco.iiot.filterByType=function(e){var t=null;switch(e.nodetype){case"read":t=r.bianco.iiot.filterByReadType(e);break;case"write":t=r.bianco.iiot.filterByWriteType(e);break;case"listen":t=r.bianco.iiot.filterByListenType(e);break;case"browse":t=r.bianco.iiot.filterByBrowserType(e);break;case"crawl":t=r.bianco.iiot.filterByCrawlerType(e);break;default:a.internalDebugLog("unknown node type injected to filter for "+e.nodetype),r.showErrors&&r.error(new Error("unknown node type injected to filter for "+e.nodetype),e)}return t},r.bianco.iiot.convertResult=function(t,o){try{var e=null;return 0<=r.fixPoint&&r.fixedValue&&(e=Number.parseFloat(o).toFixed(r.fixPoint),e=parseFloat(e)),0<=r.precision&&r.withPrecision&&(e=Number.parseFloat(o).toPrecision(r.precision),e=parseFloat(e)),null===e&&(e=o),r.withValueCheck&&(e<r.minvalue||e>r.maxvalue)&&(e=r.defaultvalue),e}catch(e){return a.internalDebugLog("result converting error "+e.message),r.showErrors&&r.error(e,t),o}},r.bianco.iiot.convertResultValue=function(e){var t=e.payload;return null==t?(a.internalDebugLog("result null or undefined"),r.showErrors&&r.error(new Error("converted result null or undefined"),e),t):(t.hasOwnProperty("value")&&(t=t.value),r.datatype?null==(t=r.bianco.iiot.convertDataType(t))?(a.internalDebugLog("data type result null or undefined"),r.showErrors&&r.error(new Error("converted by data type result null or undefined"),e)):t=r.bianco.iiot.convertResult(e,t):a.internalDebugLog("data type unknown - set the data type inside the result filter node"),t)},r.bianco.iiot.filterResult=function(e){return("read"===e.nodetype||"listen"===e.nodetype)&&r.bianco.iiot.convertResultValue(e)||e.payload},r.bianco.iiot.extractValueFromOPCUAArrayStructure=function(e,t){var o=null,r=e.payload[t];return r?o=r.hasOwnProperty("value")?r.value.hasOwnProperty("value")?r.value.value:r.value:r:o},r.bianco.iiot.extractValueFromOPCUAStructure=function(e){return e.payload.hasOwnProperty("value")?e.payload.value.hasOwnProperty("value")?e.payload.value.value:e.payload.value:e.payload},r.bianco.iiot.filterByReadType=function(e){var t=null;return(t=e.payload.length>=r.entry?r.bianco.iiot.extractValueFromOPCUAArrayStructure(e,r.entry-1):r.bianco.iiot.extractValueFromOPCUAStructure(e)).hasOwnProperty("value")&&(t=t.value),t},r.bianco.iiot.filterByWriteType=function(e){return null},r.bianco.iiot.filterByListenType=function(e){var t=null;return(t=e.payload&&e.payload.hasOwnProperty("value")?e.payload.value:e.payload)&&t.hasOwnProperty("value")&&(t=t.value),t},r.bianco.iiot.filterByBrowserType=function(e){var t=a.core.filterListByNodeId(r.nodeId,e.payload.browserResults);return e.addressSpaceItems&&e.addressSpaceItems.length&&(e.addressSpaceItems=a.core.filterListByNodeId(r.nodeId,e.addressSpaceItems)),e.nodesToRead&&e.nodesToRead.length&&(e.nodesToRead=a.core.filterListEntryByNodeId(r.nodeId,e.nodesToRead),e.nodesToReadCount=e.nodesToRead.length),e.addressItemsToRead&&e.addressItemsToRead.length&&(e.addressItemsToRead=a.core.filterListByNodeId(r.nodeId,e.addressItemsToRead),e.addressItemsToReadCount=e.addressItemsToRead.length),e.addressItemsToBrowse&&e.addressItemsToBrowse.length&&(e.addressItemsToBrowse=a.core.filterListByNodeId(r.nodeId,e.addressItemsToBrowse),e.addressItemsToBrowseCount=e.addressItemsToBrowse.length),t},r.bianco.iiot.filterByCrawlerType=function(e){var t=a.core.filterListByNodeId(r.nodeId,e.payload.crawlerResults);return e.addressSpaceItems&&e.addressSpaceItems.length&&(e.addressItems=a.core.filterListByNodeId(r.nodeId,e.addressSpaceItems)),t},r.bianco.iiot.convertDataType=function(e){return a.internalDebugLog("data type convert for "+r.nodeId),a.core.convertDataValueByDataType({value:e},r.datatype)},r.withValueCheck&&(r.minvalue=r.bianco.iiot.convertDataType(r.minvalue),r.maxvalue=r.bianco.iiot.convertDataType(r.maxvalue)),r.status({fill:"green",shape:"dot",text:"active"})})};
//# sourceMappingURL=maps/opcua-iiot-result-filter.js.map
