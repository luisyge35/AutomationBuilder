"use strict";module.exports=function(r){require("source-map-support").install();var a=require("./core/opcua-iiot-core-browser");r.nodes.registerType("OPCUA-IIoT-Crawler",function(e){r.nodes.createNode(this,e),this.name=e.name,this.justValue=e.justValue,this.singleResult=e.singleResult,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.activateUnsetFilter=e.activateUnsetFilter,this.activateFilters=e.activateFilters,this.negateFilter=e.negateFilter,this.filters=e.filters,this.delayPerMessage=e.delayPerMessage||.2,this.connector=r.nodes.getNode(e.connector);var s=a.initBrowserNode(this);a.core.assert(s.bianco.iiot),s.bianco.iiot.delayMessageTimer=[],s.bianco.iiot.filterCrawlerResults=function(e){var t=e||[],o=[];return s.activateFilters&&s.filters&&0<s.filters.length&&(t.forEach(function(e){s.bianco.iiot.itemIsNotToFilter(e)&&o.push(e)}),t=o),s.justValue&&t.forEach(function(e){e.references&&delete e.references}),t},s.bianco.iiot.itemIsNotToFilter=function(t){var o=a.core.checkItemForUnsetState(s,t);return o&&s.filters.forEach(function(e){o=a.core.checkCrawlerItemIsNotToFilter(s,t,e,o)}),s.negateFilter?!o:o},s.bianco.iiot.crawl=function(e,t){a.core.checkSessionNotValid(s.bianco.iiot.opcuaSession,"Crawler")||(a.internalDebugLog("Browse Topic To Call Crawler "+s.browseTopic),s.showStatusActivities&&a.core.setNodeStatusTo(s,"crawling"),a.crawl(e,s.browseTopic,t).then(function(e){a.internalDebugLog(e.rootNodeId+" Crawler Results "+e.crawlerResult.length),s.bianco.iiot.sendMessage(e.message,s.bianco.iiot.filterCrawlerResults(e.message,e.crawlerResult))}).catch(function(e){a.browseErrorHandling(s,e,t)}))},s.bianco.iiot.crawlForSingleResult=function(e,t){a.crawlAddressSpaceItems(e,t).then(function(e){a.internalDebugLog(e.rootNodeId+" Crawler Results "+e.crawlerResult.length),s.bianco.iiot.sendMessage(e.message,s.bianco.iiot.filterCrawlerResults(e.crawlerResult))}).catch(function(e){a.browseErrorHandling(s,e,t)})},s.bianco.iiot.crawlForResults=function(t,o){o.addressSpaceItems.map(function(e){a.crawl(t,e.nodeId).then(function(e){a.internalDebugLog(e.rootNodeId+" Crawler Results "+e.crawlerResult.length),s.bianco.iiot.sendMessage(e.message,s.bianco.iiot.filterCrawlerResults(e.crawlerResult))}).catch(function(e){a.browseErrorHandling(s,e,o)})})},s.bianco.iiot.crawlNodeList=function(e,t){s.showStatusActivities&&a.core.setNodeStatusTo(s,"crawling"),s.singleResult?s.bianco.iiot.crawlForSingleResult(e,t):s.bianco.iiot.crawlForResults(e,t)},s.bianco.iiot.sendMessage=function(e,t){var o=Object.assign({},e);o.nodetype="crawl";var i={crawlerResults:t};try{r.util.setMessageProperty(o,"payload",JSON.parse(JSON.stringify(i,null,2)))}catch(e){a.writeDebugLog(e),s.showErrors&&s.error(e,o),o.resultsConverted=JSON.stringify(i,null,2),o.error=e.message}s.browseTopic&&""!==s.browseTopic&&(o.payload.browseTopic=s.browseTopic),s.justValue||(o.payload.crawlerResultsCount=t.length,s.connector&&(o.payload.endpoint=s.connector.endpoint),o.payload.session=s.bianco.iiot.opcuaSession.name||"none"),s.bianco.iiot.messageList.push(o),s.showStatusActivities&&a.core.setNodeStatusTo(s,"active"),s.bianco.iiot.delayMessageTimer.push(setTimeout(function(){s.send(s.bianco.iiot.messageList.shift())},s.delayPerMessage*a.core.FAKTOR_SEC_TO_MSEC))},s.bianco.iiot.resetAllTimer=function(){s.bianco.iiot.delayMessageTimer.forEach(function(e){clearTimeout(e),e=null})},s.bianco.iiot.startCrawling=function(e){s.browseTopic&&""!==s.browseTopic?s.bianco.iiot.crawl(s.bianco.iiot.opcuaSession,e):(e.addressItemsToBrowse&&(e.addressSpaceItems=e.addressItemsToBrowse),e.addressSpaceItems&&e.addressSpaceItems.length?(a.internalDebugLog("Start Crawling On AddressSpace Items"),s.bianco.iiot.crawlNodeList(s.bianco.iiot.opcuaSession,e)):s.error(new Error("No AddressSpace Items Or Root To Crawl"),e))},s.on("input",function(e){a.core.checkConnectorState(s,e,"Crawler")&&(s.browseTopic=a.extractNodeIdFromTopic(e,s),s.bianco.iiot.startCrawling(e))}),a.core.registerToConnector(s),s.on("close",function(e){a.core.deregisterToConnector(s,function(){a.core.resetBiancoNode(s),e()})})})};
//# sourceMappingURL=maps/opcua-iiot-crawler.js.map
