"use strict";module.exports=function(o){require("source-map-support").install();var a=require("./core/opcua-iiot-core-inject"),n=require("cron");function e(e){o.nodes.createNode(this,e),this.topic=e.topic,this.payload=e.payload,this.payloadType=e.payloadType,this.repeat=e.repeat,this.crontab=e.crontab,this.once=e.once,this.startDelay=parseFloat(e.startDelay)||10,this.name=e.name,this.injectType=e.injectType||"inject",this.addressSpaceItems=e.addressSpaceItems||[];var i=this;i.bianco=a.core.createBiancoIIoT(),a.core.assert(i.bianco.iiot),i.bianco.iiot.intervalId=null,i.bianco.iiot.onceTimeout=null,i.bianco.iiot.cronjob=null,i.bianco.iiot.REPEAT_FACTOR=1e3,i.bianco.iiot.ONE_SECOND=1e3,i.bianco.iiot.INPUT_TIMEOUT_MILLISECONDS=1e3,i.bianco.iiot.repeaterSetup=function(){a.internalDebugLog("Repeat Is "+i.repeat),a.internalDebugLog("Crontab Is "+i.crontab),""!==i.repeat?(i.repeat=parseFloat(e.repeat)*i.bianco.iiot.REPEAT_FACTOR,0===i.repeat&&(i.repeat=i.bianco.iiot.ONE_SECOND),a.internalDebugLog("Repeat Interval Start With "+i.repeat+" msec."),i.bianco.iiot.intervalId&&clearInterval(i.bianco.iiot.intervalId),i.bianco.iiot.intervalId=setInterval(function(){i.emit("input",{})},i.repeat)):""!==i.crontab&&(i.bianco.iiot.cronjob=new n.CronJob(i.crontab,function(){i.emit("input",{})},null,!0))},i.bianco.iiot.resetAllTimer=function(){i.bianco.iiot.onceTimeout&&(clearTimeout(i.bianco.iiot.onceTimeout),i.bianco.iiot.onceTimeout=null),i.bianco.iiot.intervalId&&(clearInterval(i.bianco.iiot.intervalId),i.bianco.iiot.intervalId=null)},i.on("input",function(t){try{switch(t.topic=i.topic,t.nodetype="inject",t.injectType=i.injectType,t.addressSpaceItems=[],Object.assign(t.addressSpaceItems,i.addressSpaceItems),i.payloadType){case"none":t.payload="";break;case"bool":t.payload=!0===i.payload||"true"===i.payload;break;case"json":t.payload=JSON.parse(i.payload);break;case"date":t.payload=Date.now();break;default:null===i.payloadType&&""===i.payload?t.payload=Date.now():t.payload=o.util.evaluateNodeProperty(i.payload,i.payloadType,i,t)}i.send(t)}catch(e){o.settings.verbose&&i.error(e,t)}}),i.bianco.iiot.onceTimeout&&(clearTimeout(i.bianco.iiot.onceTimeout),i.bianco.iiot.onceTimeout=null);var t=parseInt(i.bianco.iiot.INPUT_TIMEOUT_MILLISECONDS*i.startDelay);i.once?(a.detailDebugLog("injecting once at start delay timeout "+t+" msec."),i.bianco.iiot.onceTimeout=setTimeout(function(){a.detailDebugLog("injecting once at start"),i.emit("input",{}),i.bianco.iiot.repeaterSetup()},t)):i.repeat||i.crontab?(a.detailDebugLog("start with delay timeout "+t+" msec."),i.bianco.iiot.onceTimeout=setTimeout(function(){a.detailDebugLog("had a start delay of "+t+" msec. to setup inject interval"),i.bianco.iiot.repeaterSetup()},t)):i.bianco.iiot.repeaterSetup()}o.nodes.registerType("OPCUA-IIoT-Inject",e),e.prototype.close=function(){var e=this;e.removeAllListeners(),a.core.isInitializedBiancoIIoTNode(e)&&(e.bianco.iiot.cronjob&&(e.bianco.iiot.cronjob.stop(),delete e.cronjob),a.core.resetBiancoNode(e))},o.httpAdmin.post("/opcuaIIoT/inject/:id",o.auth.needsPermission("opcuaIIoT.inject.write"),function(e,t){var i=o.nodes.getNode(e.params.id);if(i)try{i.receive(),t.sendStatus(200)}catch(e){t.sendStatus(500),i.error(o._("opcuaiiotinject.failed",{error:e.toString()}))}else t.sendStatus(404)})};
//# sourceMappingURL=maps/opcua-iiot-inject.js.map
