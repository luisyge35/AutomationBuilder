"use strict";require("source-map-support").install();var de=de||{biancoroyal:{opcua:{iiot:{core:{listener:{}}}}}};de.biancoroyal.opcua.iiot.core.listener.core=de.biancoroyal.opcua.iiot.core.listener.core||require("./opcua-iiot-core"),de.biancoroyal.opcua.iiot.core.listener.client=de.biancoroyal.opcua.iiot.core.listener.client||require("./opcua-iiot-core-client"),de.biancoroyal.opcua.iiot.core.listener.internalDebugLog=de.biancoroyal.opcua.iiot.core.listener.internalDebugLog||require("debug")("opcuaIIoT:listener"),de.biancoroyal.opcua.iiot.core.listener.detailDebugLog=de.biancoroyal.opcua.iiot.core.listener.detailDebugLog||require("debug")("opcuaIIoT:listener:details"),de.biancoroyal.opcua.iiot.core.listener.subscribeDebugLog=de.biancoroyal.opcua.iiot.core.listener.subscribeDebugLog||require("debug")("opcuaIIoT:listener:subscribe"),de.biancoroyal.opcua.iiot.core.listener.subscribeDetailDebugLog=de.biancoroyal.opcua.iiot.core.listener.subscribeDetailDebugLog||require("debug")("opcuaIIoT:listener:subscribe:details"),de.biancoroyal.opcua.iiot.core.listener.eventDebugLog=de.biancoroyal.opcua.iiot.core.listener.eventDebugLog||require("debug")("opcuaIIoT:listener:event"),de.biancoroyal.opcua.iiot.core.listener.eventDetailDebugLog=de.biancoroyal.opcua.iiot.core.listener.eventDetailDebugLog||require("debug")("opcuaIIoT:listener:event:details"),de.biancoroyal.opcua.iiot.core.listener.SUBSCRIBE_DEFAULT_INTERVAL=1e3,de.biancoroyal.opcua.iiot.core.listener.MIN_LISTENER_INTERVAL=0,de.biancoroyal.opcua.iiot.core.listener.MAX_LISTENER_INTERVAL=36e5,de.biancoroyal.opcua.iiot.core.listener.SUBSCRIBE_DEFAULT_QUEUE_SIZE=1,de.biancoroyal.opcua.iiot.core.listener.EVENT_DEFAULT_INTERVAL=250,de.biancoroyal.opcua.iiot.core.listener.EVENT_DEFAULT_QUEUE_SIZE=1e4,de.biancoroyal.opcua.iiot.core.listener.METHOD_TYPE="ns=0;i=0",de.biancoroyal.opcua.iiot.core.listener.RUNNING_STATE="STARTED",de.biancoroyal.opcua.iiot.core.listener.MAX_INT32=2147483647,de.biancoroyal.opcua.iiot.core.listener.Stately=de.biancoroyal.opcua.iiot.core.listener.Stately||require("stately.js"),de.biancoroyal.opcua.iiot.core.listener.createStatelyMachine=function(){return de.biancoroyal.opcua.iiot.core.listener.Stately.machine({IDLE:{requestinitsub:"REQUESTED",endsub:"END"},REQUESTED:{initsub:"INIT"},INIT:{startsub:"STARTED",terminatesub:"TERMINATED",errorsub:"ERROR"},STARTED:{terminatesub:"TERMINATED",errorsub:"ERROR"},TERMINATED:{idlesub:"IDLE",errorsub:"ERROR",endsub:"END"},ERROR:{idlesub:"IDLE",initsub:"INIT",endsub:"END"},END:{}},"IDLE")},de.biancoroyal.opcua.iiot.core.listener.getEventSubscribtionParameters=function(e){return{requestedPublishingInterval:(e=e>de.biancoroyal.opcua.iiot.core.listener.MAX_INT32?100:e)||100,requestedLifetimeCount:12e5,requestedMaxKeepAliveCount:120,maxNotificationsPerPublish:200,publishingEnabled:!0,priority:2}},de.biancoroyal.opcua.iiot.core.listener.getSubscriptionParameters=function(e){return{requestedPublishingInterval:(e=e>de.biancoroyal.opcua.iiot.core.listener.MAX_INT32?200:e)||200,requestedLifetimeCount:6e5,requestedMaxKeepAliveCount:60,maxNotificationsPerPublish:100,publishingEnabled:!0,priority:10}},de.biancoroyal.opcua.iiot.core.listener.collectAlarmFields=function(e,o,i){return{field:e,dataType:o,value:i}},de.biancoroyal.opcua.iiot.core.listener.getBasicEventFields=function(){return["EventId","SourceName","Message","ReceiveTime"]},de.biancoroyal.opcua.iiot.core.listener.getAllEventFields=function(){return["ConditionName","ConditionType","ConditionClassId","ConditionClassName","ConditionVariableType","SourceNode","BranchId","EventType","Severity","Retain","Comment","Comment.SourceTimestamp","EnabledState","EnabledState.Id","EnabledState.EffectiveDisplayName","EnabledState.TransitionTime","LastSeverity","LastSeverity.SourceTimestamp","Quality","Quality.SourceTimestamp","Time","ClientUserId","AckedState","AckedState.Id","ConfirmedState","ConfirmedState.Id","LimitState","LimitState.Id","ActiveState","ActiveState.Id"]},de.biancoroyal.opcua.iiot.core.listener.getStateFields=function(){return["ConditionName","SourceNode","Quality","Time","EnabledState","EnabledState.Id","EnabledState.EffectiveDisplayName","EnabledState.TransitionTime","AckedState","AckedState.Id","ConfirmedState","ConfirmedState.Id","LimitState","LimitState.Id","ActiveState","ActiveState.Id"]},de.biancoroyal.opcua.iiot.core.listener.getConditionFields=function(){return["Time","Quality","BranchId","SourceNode","ConditionName","ConditionType","ConditionClassId","ConditionClassName","ConditionVariableType"]},de.biancoroyal.opcua.iiot.core.listener.monitorItems=function(o,i,e){var t=de.biancoroyal.opcua.iiot.core.listener,r=!0,n=!1,a=void 0;try{for(var c,u=i.addressSpaceItems[Symbol.iterator]();!(r=(c=u.next()).done);r=!0){var l=c.value;if(!l.nodeId)return void t.subscribeDebugLog("Address Space Item Not Valid to Monitor "+l);if(l.datatypeName===de.biancoroyal.opcua.iiot.core.listener.METHOD_TYPE)return void t.subscribeDebugLog("Address Space Item Not Allowed to Monitor "+l);var d="string"==typeof l.nodeId?l.nodeId:l.nodeId.toString();d&&(t.subscribeDebugLog("Monitored Item Subscribing "+d),this.buildNewMonitoredItem(d,i,e).then(function(e){e.monitoredItem.monitoredItemId&&(t.subscribeDebugLog("Monitored Item Subscribed Id:"+e.monitoredItem.monitoredItemId+" to "+e.nodeId),o.bianco.iiot.monitoredASO.set(e.nodeId.toString(),{monitoredItem:e.monitoredItem,topic:i.topic||o.topic}))}).catch(function(e){t.subscribeDebugLog(e),o.showErrors&&o.error(e,i)}))}}catch(e){n=!0,a=e}finally{try{r||null==u.return||u.return()}finally{if(n)throw a}}},de.biancoroyal.opcua.iiot.core.listener.buildNewMonitoredItem=function(n,a,c){var u=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(i,t){if(n){var e,o,r=a.payload.listenerParameters?a.payload.listenerParameters:a.payload;e="number"==typeof r.interval&&r.interval<=u.MAX_LISTENER_INTERVAL&&r.interval>=u.MIN_LISTENER_INTERVAL?parseInt(r.interval):u.SUBSCRIBE_DEFAULT_INTERVAL,o=r.queueSize&&"number"==typeof r.queueSize?parseInt(r.queueSize):u.SUBSCRIBE_DEFAULT_QUEUE_SIZE,c.monitor({nodeId:u.core.nodeOPCUA.resolveNodeId(n),attributeId:u.core.nodeOPCUA.AttributeIds.Value},{samplingInterval:e,discardOldest:!0,queueSize:o},u.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(u.internalDebugLog("subscribing monitored item "+e),t(e)):i({nodeId:n,monitoredItem:o})})}else t(new Error("NodeId Is Not Valid"))})},de.biancoroyal.opcua.iiot.core.listener.buildNewMonitoredItemGroup=function(e,c,u,l){var d=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(i,t){if(u){var e,o,r=c.payload.listenerParameters?c.payload.listenerParameters:c.payload;e="number"==typeof r.interval&&r.interval<=d.MAX_LISTENER_INTERVAL&&r.interval>=d.MIN_LISTENER_INTERVAL?parseInt(r.interval):d.SUBSCRIBE_DEFAULT_INTERVAL,o=r.queueSize&&"number"==typeof r.queueSize?parseInt(r.queueSize):d.SUBSCRIBE_DEFAULT_QUEUE_SIZE;var n=u.filter(function(e){return e.datatypeName!==de.biancoroyal.opcua.iiot.core.listener.METHOD_TYPE}),a=[];n.forEach(function(e){a.push({nodeId:d.core.nodeOPCUA.resolveNodeId(e.nodeId),attributeId:d.core.nodeOPCUA.AttributeIds.Value})}),l.monitorItems(a,{samplingInterval:e,discardOldest:!0,queueSize:o},d.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(d.internalDebugLog("subscribing monitored item group "+e),t(e)):i({addressSpaceItems:u,monitoredItemGroup:o})})}else t(new Error("NodeId Is Not Valid"))})},de.biancoroyal.opcua.iiot.core.listener.buildNewEventItem=function(r,n,a){var c=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(i,t){var e,o;r?(e="number"==typeof n.payload.interval&&n.payload.interval<c.MAX_LISTENER_INTERVAL?parseInt(n.payload.interval):c.EVENT_DEFAULT_INTERVAL,o="number"==typeof n.payload.queueSize?parseInt(n.payload.queueSize):c.EVENT_DEFAULT_QUEUE_SIZE,a.monitor({nodeId:c.core.nodeOPCUA.resolveNodeId(r),attributeId:c.core.nodeOPCUA.AttributeIds.EventNotifier},{samplingInterval:e,discardOldest:!0,queueSize:o,filter:n.payload.eventFilter},c.core.nodeOPCUA.read_service.TimestampsToReturn.Both,function(e,o){e?(c.internalDebugLog("subscribing event item "+e),t(e)):i({nodeId:r,monitoredItem:o})})):t(new Error("NodeId Is Not Valid"))})},de.biancoroyal.opcua.iiot.core.listener.analyzeEvent=function(a,c,u){var l=de.biancoroyal.opcua.iiot.core.listener.core,d=de.biancoroyal.opcua.iiot.core.listener;return new Promise(function(e,t){if(a)if(c&&"function"==typeof c)if(u){var o=0,r={},n=[];u.forEach(function(i){d.eventDebugLog("variant entry: "+i.toString());try{i.dataType&&i.value&&(r=d.collectAlarmFields(u.monitoringParameters.filter.selectClauses[o],i.dataType.key.toString(),i.value),i.dataType===l.nodeOPCUA.DataType.NodeId?c(a,i.value,function(e,o){e?t(e):(r.browseName=o,n.push({eventInformation:r,eventData:i.toJSON()}))}):n.push({eventInformation:r,eventData:i.toJSON()})),o++}catch(e){r={error:e},n.push({eventInformation:r,eventData:i.toJSON()})}}),e(n)}else t(new Error("Event Response Not Valid"));else t(new Error("BrowseForBrowseName Is Not Valid Function"));else t(new Error("Session Is Not Valid To Analyze Event"))})},de.biancoroyal.opcua.iiot.core.listener.checkState=function(e,o,i){return this.internalDebugLog("Check Listener State "+e.bianco.iiot.stateMachine.getMachineState()+" By "+i),!e.connector||!e.bianco.iiot.stateMachine||e.bianco.iiot.stateMachine.getMachineState()===this.RUNNING_STATE||(this.internalDebugLog("Wrong Listener State "+e.bianco.iiot.stateMachine.getMachineState()+" By "+i),e.showErrors&&e.error(new Error("Listener Not "+this.RUNNING_STATE+" On "+i),o),!1)},de.biancoroyal.opcua.iiot.core.listener.initListenerNode=function(e){var o=this.core.initClientNode(e);return o.bianco.iiot.opcuaSubscription=null,o.bianco.iiot.monitoredItems=new Map,o.bianco.iiot.monitoredASO=new Map,o.bianco.iiot.messageQueue=[],o},module.exports=de.biancoroyal.opcua.iiot.core.listener;
//# sourceMappingURL=../maps/core/opcua-iiot-core-listener.js.map
