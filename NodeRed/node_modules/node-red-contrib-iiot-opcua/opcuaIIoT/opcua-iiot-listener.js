"use strict";function _typeof(o){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(o){return typeof o}:function(o){return o&&"function"==typeof Symbol&&o.constructor===Symbol&&o!==Symbol.prototype?"symbol":typeof o})(o)}module.exports=function(a){require("source-map-support").install();var d=require("./core/opcua-iiot-core-listener"),e=require("es6-map"),t=require("underscore");a.nodes.registerType("OPCUA-IIoT-Listener",function(o){a.nodes.createNode(this,o),this.action=o.action,this.queueSize=o.queueSize||1,this.name=o.name,this.topic=o.topic,this.justValue=o.justValue,this.useGroupItems=o.useGroupItems,this.showStatusActivities=o.showStatusActivities,this.showErrors=o.showErrors,this.connector=a.nodes.getNode(o.connector);var s=d.initListenerNode(this);d.core.assert(s.bianco.iiot);var r=d.core.nodeOPCUA.StatusCodes,i=d.core.nodeOPCUA.AttributeIds;s.bianco.iiot.stateMachine=d.createStatelyMachine(),d.internalDebugLog("Start FSM: "+s.bianco.iiot.stateMachine.getMachineState()),d.detailDebugLog("FSM events:"+s.bianco.iiot.stateMachine.getMachineEvents()),s.bianco.iiot.createSubscription=function(o){if("IDLE"===s.bianco.iiot.stateMachine.getMachineState()){d.internalDebugLog("Create Subscription On State "+s.bianco.iiot.stateMachine.getMachineState()),s.bianco.iiot.opcuaSubscription=null,s.bianco.iiot.stateMachine.requestinitsub();var e="number"==typeof o.payload?o.payload:null,i=o.payload.listenerParameters?o.payload.listenerParameters.options:o.payload.options;if("events"!==s.action){d.internalDebugLog("create monitoring subscription");var t=i||d.getSubscriptionParameters(e);s.bianco.iiot.makeSubscription(t)}else{d.internalDebugLog("create event subscription");var n=i||d.getEventSubscribtionParameters(e);s.bianco.iiot.makeSubscription(n)}}else d.internalDebugLog("New Subscription Request On State "+s.bianco.iiot.stateMachine.getMachineState())},s.bianco.iiot.setSubscriptionEvents=function(o){o.on("started",function(){d.internalDebugLog("Subscription started"),d.core.setNodeStatusTo(s,"started"),s.bianco.iiot.monitoredItems.clear(),s.bianco.iiot.stateMachine.startsub()}),o.on("terminated",function(){d.internalDebugLog("Subscription terminated"),d.core.setNodeStatusTo(s,"terminated"),s.bianco.iiot.stateMachine.terminatesub().idlesub(),s.bianco.iiot.resetSubscription()}),o.on("internal_error",function(o){d.internalDebugLog("internal_error: "+o.message),s.showErrors&&s.error(o,{payload:"Internal Error"}),d.core.setNodeStatusTo(s,"error"),s.bianco.iiot.stateMachine.errorsub(),s.bianco.iiot.resetSubscription()}),o.on("item_added",function(o){s.bianco.iiot.setMonitoring(o),s.bianco.iiot.updateSubscriptionStatus()})},s.bianco.iiot.makeSubscription=function(o){d.core.checkSessionNotValid(s.bianco.iiot.opcuaSession,"ListenerSubscription")||(o?(d.internalDebugLog("Subscription Parameters: "+JSON.stringify(o)),s.bianco.iiot.opcuaSubscription=new d.core.nodeOPCUA.ClientSubscription(s.bianco.iiot.opcuaSession,o),d.internalDebugLog("New Subscription Created"),s.connector&&(s.connector.bianco.iiot.hasOpcUaSubscriptions=!0),s.bianco.iiot.setSubscriptionEvents(s.bianco.iiot.opcuaSubscription),s.bianco.iiot.stateMachine.initsub()):d.internalDebugLog("Subscription Parameters Not Valid"))},s.bianco.iiot.resetSubscription=function(){s.bianco.iiot.sendAllMonitoredItems("SUBSCRIPTION TERMINATED")},s.bianco.iiot.sendAllMonitoredItems=function(o){var i=[];s.bianco.iiot.monitoredASO.forEach(function(o,e){i.push({name:"",nodeId:e,datatypeName:""})}),s.send({payload:o,addressSpaceItems:i}),s.bianco.iiot.monitoredItems.clear(),s.bianco.iiot.monitoredASO.clear()},s.bianco.iiot.subscribeActionInput=function(o){s.bianco.iiot.stateMachine.getMachineState()!==d.RUNNING_STATE?s.bianco.iiot.messageQueue.push(o):s.bianco.iiot.subscribeMonitoredItem(o)},s.bianco.iiot.subscribeEventsInput=function(o){s.bianco.iiot.stateMachine.getMachineState()!==d.RUNNING_STATE?s.bianco.iiot.messageQueue.push(o):s.bianco.iiot.subscribeMonitoredEvent(o)},s.bianco.iiot.updateSubscriptionStatus=function(){d.internalDebugLog("listening ("+s.bianco.iiot.monitoredItems.size+")"),d.core.setNodeStatusTo(s,"listening ("+s.bianco.iiot.monitoredItems.size+")")},s.bianco.iiot.handleMonitoringOfGroupedItems=function(e){s.bianco.iiot.monitoredItemGroup&&null!==s.bianco.iiot.monitoredItemGroup.groupId?s.bianco.iiot.monitoredItemGroup.terminate(function(o){o&&(d.internalDebugLog("Monitoring Terminate Error"),d.internalDebugLog(o)),s.bianco.iiot.monitoredItems.clear(),s.bianco.iiot.monitoredASO.clear(),s.bianco.iiot.monitoredItemGroup.groupId=null,s.bianco.iiot.updateSubscriptionStatus()}):d.buildNewMonitoredItemGroup(s,e,e.addressSpaceItems,s.bianco.iiot.opcuaSubscription).then(function(o){o.monitoredItemGroup?(o.monitoredItemGroup.groupId=t.uniqueId("group_"),s.bianco.iiot.monitoredItemGroup=o.monitoredItemGroup):s.error(new Error("No Monitored Item Group In Result Of NodeOPCUA"))}).catch(function(o){d.subscribeDebugLog("Monitoring Build Item Group Error"),d.subscribeDebugLog(o),s.showErrors&&s.error(o,e)})},s.bianco.iiot.handleMonitoringOfItems=function(t){var o=t.addressSpaceItems.filter(function(o){var e="string"==typeof o.nodeId?o.nodeId:o.nodeId.toString();return void 0===s.bianco.iiot.monitoredASO.get(e)}),e=t.addressSpaceItems.filter(function(o){var e="string"==typeof o.nodeId?o.nodeId:o.nodeId.toString();return void 0!==s.bianco.iiot.monitoredASO.get(e)});if(0<o.length){var i=Object.assign({},t);i.addressSpaceItems=o,d.subscribeDebugLog("itemsToMonitor "+o.length),d.monitorItems(s,i,s.bianco.iiot.opcuaSubscription)}0<e.length&&(d.subscribeDebugLog("itemsToTerminate "+e.length),e.forEach(function(o){var e="string"==typeof o.nodeId?o.nodeId:o.nodeId.toString(),i=s.bianco.iiot.monitoredASO.get(e);i&&i.monitoredItem?(d.subscribeDebugLog("Monitored Item Unsubscribe "+e),i.monitoredItem.terminate(function(o){d.subscribeDebugLog("Terminated Monitored Item "+i.monitoredItem.itemToMonitor.nodeId),s.bianco.iiot.monitoredItemTerminated(t,i.monitoredItem,e,o)})):d.subscribeDebugLog("Monitored Item Was Not Monitoring "+e)}))},s.bianco.iiot.subscribeMonitoredItem=function(o){d.core.checkSessionNotValid(s.bianco.iiot.opcuaSession,"MonitorListener")||d.checkState(s,o,"Monitoring")&&d.core.isInitializedBiancoIIoTNode(s)&&o.addressSpaceItems.length&&(s.useGroupItems?s.bianco.iiot.handleMonitoringOfGroupedItems(o):s.bianco.iiot.handleMonitoringOfItems(o))},s.bianco.iiot.handleEventSubscriptions=function(n){if(d.core.isInitializedBiancoIIoTNode(s)){var o=!0,e=!1,i=void 0;try{for(var r,t=function(){var o=r.value;if(!o.nodeId)return d.eventDebugLog("Address Space Item Not Valid to Monitor Event Of "+o),{v:void 0};if("ns=0;i=0"===o.datatypeName)return d.subscribeDebugLog("Address Space Item Not Allowed to Monitor "+o),{v:void 0};var e=void 0;e="string"==typeof o.nodeId?o.nodeId:o.nodeId.toString();var i=s.bianco.iiot.monitoredASO.get(e);if(i){d.eventDebugLog("Terminate Event Item"+e);var t=Object.assign({},n);i.monitoredItem.terminate(function(o){d.eventDebugLog("Terminated Monitored Item "+i.monitoredItem.itemToMonitor.nodeId),s.bianco.iiot.monitoredItemTerminated(t,i.monitoredItem,e,o)})}else d.eventDebugLog("Regsiter Event Item "+e),d.buildNewEventItem(e,n,s.bianco.iiot.opcuaSubscription).then(function(o){o.monitoredItem.monitoredItemId&&(d.eventDebugLog("Event Item Regsitered "+o.monitoredItem.monitoredItemId+" to "+o.nodeId),s.bianco.iiot.monitoredASO.set(o.nodeId.toString(),{monitoredItem:o.monitoredItem,topic:n.topic||s.topic}))}).catch(function(o){d.eventDebugLog("Build Event Error"),d.eventDebugLog(o),s.showErrors&&s.error(o,n)})},a=n.addressSpaceItems[Symbol.iterator]();!(o=(r=a.next()).done);o=!0){var c=t();if("object"===_typeof(c))return c.v}}catch(o){e=!0,i=o}finally{try{o||null==a.return||a.return()}finally{if(e)throw i}}}},s.bianco.iiot.subscribeMonitoredEvent=function(o){d.core.checkSessionNotValid(s.bianco.iiot.opcuaSession,"EventListener")||d.checkState(s,o,"Event")&&d.core.isInitializedBiancoIIoTNode(s)&&s.bianco.iiot.handleEventSubscriptions(o)},s.bianco.iiot.monitoredItemTerminated=function(o,e,i,t){t&&(e&&e.monitoredItemId?d.internalDebugLog(t.message+" on "+e.monitoredItemId):d.internalDebugLog(t.message+" on monitoredItem"),s.showErrors&&s.error(t,o)),d.core.isInitializedBiancoIIoTNode(s)&&s.bianco.iiot.updateMonitoredItemLists(e,i)},s.bianco.iiot.updateMonitoredItemLists=function(t,o){d.internalDebugLog("updateMonitoredItemLists = UMIL"),t&&t.itemToMonitor&&(s.bianco.iiot.monitoredItems.has(t.monitoredItemId)&&s.bianco.iiot.monitoredItems.delete(t.monitoredItemId),d.core.isNodeId(t.itemToMonitor.nodeId)?(d.internalDebugLog("UMIL Terminate Monitored Item "+t.itemToMonitor.nodeId),s.bianco.iiot.monitoredASO.has(o)&&s.bianco.iiot.monitoredASO.delete(o)):(d.internalDebugLog("UMIL monitoredItem NodeId is not valid Id:"+t.monitoredItemId),s.bianco.iiot.monitoredASO.forEach(function(o,e,i){d.internalDebugLog("UMIL monitoredItem removing from ASO list key:"+e+" value "+o.monitoredItem.monitoredItemId),o.monitoredItem.monitoredItemId&&o.monitoredItem.monitoredItemId===t.monitoredItemId&&(d.internalDebugLog("UMIL monitoredItem removed from ASO list"+e),i.delete(e))})),s.bianco.iiot.updateSubscriptionStatus())},s.bianco.iiot.setMonitoring=function(o){var e=o;e&&void 0!==e.monitoredItemId?(d.core.isNodeId(e.itemToMonitor.nodeId)||d.internalDebugLog("monitoredItem NodeId is not valid Id:"+e.monitoredItemId),d.internalDebugLog("add monitoredItem to list Id:"+e.monitoredItemId+" nodeId: "+e.itemToMonitor.nodeId),s.bianco.iiot.monitoredItems.set(e.monitoredItemId,e),e.on("initialized",function(){d.internalDebugLog("monitoredItem "+e.itemToMonitor.nodeId+" initialized on "+e.monitoredItemId)}),e.on("changed",function(o){d.detailDebugLog("data changed for item: "+e.itemToMonitor.nodeId+" with Id "+e.monitoredItemId),e.monitoringParameters.filter?s.bianco.iiot.sendDataFromEvent(e,o):s.bianco.iiot.sendDataFromMonitoredItem(e,o)}),e.on("error",function(o){d.internalDebugLog("monitoredItem Error: "+o.message+" on "+e.monitoredItemId),s.showErrors&&s.error(o,{payload:"Monitored Item Error",monitoredItem:e}),s.bianco.iiot.updateMonitoredItemLists(e,e.itemToMonitor.nodeId),d.core.isSessionBad(o)&&(s.bianco.iiot.sendAllMonitoredItems("BAD SESSION"),s.bianco.iiot.terminateSubscription(function(){s.emit("opcua_client_not_ready")}))}),e.on("terminated",function(){e.removeAllListeners(),d.internalDebugLog("Terminated For "+e.monitoredItemId),s.bianco.iiot.updateMonitoredItemLists(e,e.itemToMonitor.nodeId)})):d.internalDebugLog("monitoredItem Id from server is not valid Id: "+e.monitoredItemId)},s.bianco.iiot.sendDataFromMonitoredItem=function(o,e){if(d.core.isInitializedBiancoIIoTNode(s))if(o){var i=d.core.isNodeId(o.itemToMonitor.nodeId)?o.itemToMonitor.nodeId.toString():"invalid",t=s.bianco.iiot.monitoredASO.get(i),n={payload:{},topic:t?t.topic:s.topic,addressSpaceItems:[{name:"",nodeId:i,datatypeName:""}],nodetype:"listen",injectType:"subscribe"};d.internalDebugLog("sendDataFromMonitoredItem: "+n.addressSpaceItems[0].nodeId);var r={};if(n.justValue=s.justValue,s.justValue){r=JSON.stringify(e,null,2);try{a.util.setMessageProperty(n,"payload",JSON.parse(r))}catch(o){s.showErrors&&(s.warn("JSON not to parse from string for monitored item"),s.error(o,n)),n.payload=r,n.error=o.message}}else n.payload={dataValue:e,monitoredItem:o};s.send(n)}else d.internalDebugLog("Monitored Item Is Not Valid On Change Event While Monitoring")},s.bianco.iiot.handleEventResults=function(e,o,i,t){d.eventDetailDebugLog("Monitored Event Results "+i);var n={};if(s.justValue){n=JSON.stringify({dataValue:o},null,2);try{a.util.setMessageProperty(e,"payload",JSON.parse(n))}catch(o){s.showErrors&&(s.warn("JSON not to parse from string for monitored item"),s.error(o,e)),e.payload=n,e.error=o.message}}else e.payload={dataValue:o,eventResults:i,monitoredItem:t};s.send(e)},s.bianco.iiot.sendDataFromEvent=function(e,i){if(d.core.isInitializedBiancoIIoTNode(s))if(e){var o=d.core.isNodeId(e.itemToMonitor.nodeId)?e.itemToMonitor.nodeId.toString():"invalid",t=s.bianco.iiot.monitoredASO.get(o),n={payload:{},topic:(t?t.topic:s.topic)||s.topic,addressSpaceItems:[{name:"",nodeId:o,datatypeName:""}],nodetype:"listen",injectType:"event"};d.analyzeEvent(s.bianco.iiot.opcuaSession,s.bianco.iiot.getBrowseName,i).then(function(o){s.bianco.iiot.handleEventResults(n,i,o,e)}).catch(function(o){d.core.isInitializedBiancoIIoTNode(s)?s.bianco.iiot.errorHandling(o):d.internalDebugLog(o.message)})}else d.internalDebugLog("Monitored Item Is Not Valid On Change Event While Monitoring")},s.bianco.iiot.errorHandling=function(o){d.internalDebugLog("Basic Error Handling"),d.internalDebugLog(o),s.showErrors&&s.error(o,{payload:"Error Handling"}),d.core.isInitializedBiancoIIoTNode(s)&&o&&d.core.isSessionBad(o)&&(s.bianco.iiot.sendAllMonitoredItems("BAD SESSION"),s.bianco.iiot.terminateSubscription(function(){s.emit("opcua_client_not_ready")}))},s.bianco.iiot.getBrowseName=function(o,e,n){d.client.read(o,[{nodeId:e,attributeId:i.BrowseName}],function(o,e,i){if(o)n&&n(o,"Unknown");else if(i[0].statusCode===r.Good){var t=i[0].value.value.name;n&&n(null,t)}})},s.bianco.iiot.handleListenerInput=function(o){if(d.core.isInitializedBiancoIIoTNode(s))switch(s.action){case"subscribe":s.bianco.iiot.subscribeMonitoredItem(o);break;case"events":s.bianco.iiot.subscribeMonitoredEvent(o);break;default:s.error(new Error("Type Of Action To Listener Is Not Valid"),o)}},s.on("input",function(o){if(d.core.isInitializedBiancoIIoTNode(s)&&d.core.checkConnectorState(s,o,"Listener")){if("browse"===o.nodetype&&(o.nodetype="inject",o.injectType="listen",o.addressSpaceItems=d.core.buildNodesToListen(o)),!o.addressSpaceItems||!o.addressSpaceItems.length)return d.subscribeDebugLog("Address-Space-Item Set Not Valid"),void(s.showErrors&&s.error(new Error("Address-Space-Item Set Not Valid"),o));if("IDLE"===s.bianco.iiot.stateMachine.getMachineState())s.bianco.iiot.messageQueue.push(o),s.bianco.iiot.createSubscription(o);else{if(!d.checkState(s,o,"Input"))return void s.bianco.iiot.messageQueue.push(o);s.bianco.iiot.handleListenerInput(o)}}}),d.core.registerToConnector(s),s.connector&&(s.connector.on("connector_init",function(){s.bianco&&s.bianco.iiot&&(d.internalDebugLog("Reset Subscription On Connector Init"),s.bianco.iiot.opcuaSubscription=null,s.bianco.iiot.monitoredItems=new e,s.bianco.iiot.monitoredASO=new e,s.bianco.iiot.stateMachine=d.createStatelyMachine(),s.bianco.iiot.monitoredItemGroup=null)}),s.connector.on("connection_stopped",function(){s.bianco&&s.bianco.iiot&&s.bianco.iiot.terminateSubscription(function(){s.bianco.iiot.opcuaSubscription=null,d.internalDebugLog("Subscription Was Terminated On Connector Event -> connection stopped")})}),s.connector.on("connection_end",function(){s.bianco&&s.bianco.iiot&&s.bianco.iiot.terminateSubscription(function(){s.bianco.iiot.opcuaSubscription=null,d.internalDebugLog("Subscription Was Terminated On Connector Event -> connection ends")})}),s.connector.on("connection_reconfigure",function(){s.bianco&&s.bianco.iiot&&s.bianco.iiot.terminateSubscription(function(){s.bianco.iiot.opcuaSubscription=null,d.internalDebugLog("Subscription Was Terminated On Connector Event -> connection reconfigure")})}),s.connector.on("connection_renew",function(){s.bianco&&s.bianco.iiot&&s.bianco.iiot.terminateSubscription(function(){s.bianco.iiot.opcuaSubscription=null,d.internalDebugLog("Subscription Was Terminated On Connector Event -> connection renew")})})),s.bianco.iiot.terminateSubscription=function(o){d.core.isInitializedBiancoIIoTNode(s)?s.bianco.iiot.opcuaSubscription&&s.bianco.iiot.stateMachine.getMachineState()===d.RUNNING_STATE?(s.bianco.iiot.stateMachine.terminatesub(),s.bianco.iiot.opcuaSubscription.terminate(function(){s.bianco.iiot.opcuaSubscription.removeAllListeners(),s.bianco.iiot.stateMachine.idlesub(),o()})):(s.bianco.iiot.stateMachine.idlesub(),o()):o()},s.on("close",function(o){s.removeAllListeners(),d.core.isInitializedBiancoIIoTNode(s)?s.bianco.iiot.terminateSubscription(function(){s.removeAllListeners(),s.bianco.iiot.opcuaSubscription=null,d.core.deregisterToConnector(s,function(){d.core.resetBiancoNode(s),o()}),d.internalDebugLog("Close Listener Node")}):o()}),s.bianco.iiot.stateMachine.onIDLE=function(o,e,i){d.detailDebugLog("Listener IDLE Event FSM")},s.bianco.iiot.stateMachine.onREQUESTED=function(o,e,i){d.detailDebugLog("Listener REQUESTED Event FSM")},s.bianco.iiot.stateMachine.onINIT=function(o,e,i){d.detailDebugLog("Listener INIT Event FSM")},s.bianco.iiot.stateMachine.onSTARTED=function(o,e,i){switch(d.detailDebugLog("Listener STARTED Event FSM"),s.action){case"subscribe":for(;0<s.bianco.iiot.messageQueue.length;)s.bianco.iiot.subscribeMonitoredItem(s.bianco.iiot.messageQueue.shift());break;case"events":for(;0<s.bianco.iiot.messageQueue.length;)s.bianco.iiot.subscribeMonitoredEvent(s.bianco.iiot.messageQueue.shift());break;default:d.internalDebugLog("Unknown Action Type "+s.action)}},s.bianco.iiot.stateMachine.onTERMINATED=function(o,e,i){d.detailDebugLog("Listener TERMINATED Event FSM")},s.bianco.iiot.stateMachine.onERROR=function(o,e,i){d.detailDebugLog("Listener ERROR Event FSM")},s.bianco.iiot.stateMachine.onEND=function(o,e,i){d.detailDebugLog("Listener END Event FSM")}})};
//# sourceMappingURL=maps/opcua-iiot-listener.js.map
