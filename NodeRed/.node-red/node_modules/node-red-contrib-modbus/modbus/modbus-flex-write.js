"use strict";module.exports=function(a){require("source-map-support").install();var o=require("./modbus-basics"),r=require("./core/modbus-core"),i=require("debug")("contribModbus:flex:write");a.nodes.registerType("modbus-flex-write",function(e){a.nodes.createNode(this,e),this.name=e.name,this.showStatusActivities=e.showStatusActivities,this.showErrors=e.showErrors,this.emptyMsgOnFail=e.emptyMsgOnFail,this.internalDebugLog=i,this.verboseLogging=a.settings.verbose;var s=this;s.bufferMessageList=new Map,o.setNodeStatusTo("waiting",s);var t=a.nodes.getNode(e.server);t&&(t.registerForModbus(s),o.initModbusClientEvents(s,t),s.onModbusWriteDone=function(e,a){s.showStatusActivities&&o.setNodeStatusTo("writing done",s),s.send(r.buildMessage(s.bufferMessageList,a.payload,e,a))},s.onModbusWriteError=function(e,a){i(e.message),s.showErrors&&s.error(e,a),o.emptyMsgOnFail(s,e,a),o.setModbusError(s,t,e,r.getOriginalMessage(s.bufferMessageList,a))},s.prepareMsg=function(e){return"string"==typeof e.payload&&(e.payload=JSON.parse(e.payload)),e.payload.fc=parseInt(e.payload.fc),e.payload.unitid=parseInt(e.payload.unitid),e.payload.address=parseInt(e.payload.address),e.payload.quantity=parseInt(e.payload.quantity),e},s.isValidModbusMsg=function(e){var a=!0;return Number.isInteger(e.payload.fc)&&(5===e.payload.fc||6===e.payload.fc||15===e.payload.fc||16===e.payload.fc)||(s.error("FC Not Valid",e),a&=!1),!a||Number.isInteger(e.payload.address)&&0<=e.payload.address&&e.payload.address<=65535||(s.error("Address Not Valid",e),a&=!1),!a||Number.isInteger(e.payload.quantity)&&1<=e.payload.quantity&&e.payload.quantity<=65535||(s.error("Quantity Not Valid",e),a&=!1),a},s.setMsgPayloadFromHTTPRequests=function(e){return Object.prototype.hasOwnProperty.call(e.payload,"value")&&"string"==typeof e.payload.value&&("true"===e.payload.value||"false"===e.payload.value?e.payload.value="true"===e.payload.value:-1<e.payload.value.indexOf(",")&&(e.payload.value=JSON.parse(e.payload.value))),e},s.buildNewMessageObject=function(e,a){var s=Object.assign({},a);return s.topic=a.topic||e.id,s.payload={value:a.payload.value||a.value,unitid:a.payload.unitid,fc:a.payload.fc,address:a.payload.address,quantity:a.payload.quantity,messageId:a.messageId},s},s.on("input",function(a){if(!o.invalidPayloadIn(a)&&t.client){try{if(a=s.prepareMsg(a),s.isValidModbusMsg(a)){(a=s.setMsgPayloadFromHTTPRequests(a)).messageId=r.getObjectId(),s.bufferMessageList.set(a.messageId,a);var e=s.buildNewMessageObject(s,a);t.emit("writeModbus",e,s.onModbusWriteDone,s.onModbusWriteError)}}catch(e){i(e.message),s.showErrors&&s.error(e,a),o.emptyMsgOnFail(s,e,a)}s.showStatusActivities&&o.setNodeStatusTo(t.actualServiceState,s)}}),s.on("close",function(e){o.setNodeStatusTo("closed",s),s.bufferMessageList.clear(),t.deregisterForModbus(s,e)}))})};
//# sourceMappingURL=maps/modbus-flex-write.js.map
