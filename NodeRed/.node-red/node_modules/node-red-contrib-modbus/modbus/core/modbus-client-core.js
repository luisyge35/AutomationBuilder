"use strict";require("source-map-support").install();var de=de||{biancoroyal:{modbus:{core:{client:{}}}}};de.biancoroyal.modbus.core.client.internalDebug=de.biancoroyal.modbus.core.client.internalDebug||require("debug")("contribModbus:core:client"),de.biancoroyal.modbus.core.client.internalDebugFSM=de.biancoroyal.modbus.core.client.internalDebugFSM||require("debug")("contribModbus:core:client:fsm"),de.biancoroyal.modbus.core.client.modbusSerialDebug=de.biancoroyal.modbus.core.client.modbusSerialDebug||require("debug")("modbus-serial"),de.biancoroyal.modbus.core.client.XStateFSM=de.biancoroyal.modbus.core.client.XStateFSM||require("@xstate/fsm"),de.biancoroyal.modbus.core.client.stateLogEnabled=de.biancoroyal.modbus.core.client.stateLogEnabled||!1,de.biancoroyal.modbus.core.client.networkErrors=["ESOCKETTIMEDOUT","ETIMEDOUT","ECONNRESET","ENETRESET","ECONNABORTED","ECONNREFUSED","ENETUNREACH","ENOTCONN","ESHUTDOWN","EHOSTDOWN","ENETDOWN","EWOULDBLOCK","EAGAIN","EHOSTUNREACH"],de.biancoroyal.modbus.core.client.createStateMachineService=function(){return this.stateLogEnabled=!1,this.XStateFSM.createMachine({id:"modbus",initial:"new",states:{new:{on:{INIT:"init",BREAK:"broken",STOP:"stopped"}},broken:{on:{INIT:"init",STOP:"stopped",FAILURE:"failed",ACTIVATE:"activated",RECONNECT:"reconnecting"}},reconnecting:{on:{INIT:"init",STOP:"stopped"}},init:{on:{OPENSERIAL:"opened",CONNECT:"connected",BREAK:"broken",FAILURE:"failed",STOP:"stopped"}},opened:{on:{CONNECT:"connected",BREAK:"broken",FAILURE:"failed",CLOSE:"closed",STOP:"stopped"}},connected:{on:{CLOSE:"closed",ACTIVATE:"activated",QUEUE:"queueing",BREAK:"broken",FAILURE:"failed",STOP:"stopped"}},activated:{on:{READ:"reading",WRITE:"writing",QUEUE:"queueing",BREAK:"broken",CLOSE:"closed",FAILURE:"failed",STOP:"stopped"}},queueing:{on:{ACTIVATE:"activated",SEND:"sending",READ:"reading",WRITE:"writing",EMPTY:"empty",BREAK:"broken",CLOSE:"closed",FAILURE:"failed",STOP:"stopped"}},empty:{on:{QUEUE:"queueing",BREAK:"broken",FAILURE:"failed",CLOSE:"closed",STOP:"stopped"}},sending:{on:{ACTIVATE:"activated",READ:"reading",WRITE:"writing",BREAK:"broken",FAILURE:"failed",STOP:"stopped"}},reading:{on:{ACTIVATE:"activated",BREAK:"broken",FAILURE:"failed",STOP:"stopped"}},writing:{on:{ACTIVATE:"activated",BREAK:"broken",FAILURE:"failed",STOP:"stopped"}},closed:{on:{FAILURE:"failed",BREAK:"broken",CONNECT:"connected",RECONNECT:"reconnecting",INIT:"init",STOP:"stopped"}},failed:{on:{CLOSE:"closed",BREAK:"broken",STOP:"stopped"}},stopped:{on:{NEW:"new",STOP:"stopped"}}}})},de.biancoroyal.modbus.core.client.getActualUnitId=function(e,n){return parseInt(n.payload.unitid)||parseInt(n.queueUnitId)||parseInt(e.unit_id)},de.biancoroyal.modbus.core.client.startStateService=function(e){return this.XStateFSM.interpret(e).start()},de.biancoroyal.modbus.core.client.checkUnitId=function(e,n){return"tcp"===n?0<=e&&e<=255:1<=e&&e<=247},de.biancoroyal.modbus.core.client.getLogFunction=function(e){return e.internalDebugLog?e.internalDebugLog:de.biancoroyal.modbus.core.client.internalDebug},de.biancoroyal.modbus.core.client.activateSendingOnSuccess=function(e,n,o,a,t){e.activateSending(t).then(function(){n(a,t)}).catch(function(e){o(e,t)}).finally(function(){e.stateService.send("ACTIVATE")})},de.biancoroyal.modbus.core.client.activateSendingOnFailure=function(e,n,o,a){e.activateSending(a).then(function(){n(o,a)}).catch(function(e){n(e,a)}).finally(function(){e.stateService.send("ACTIVATE")})},de.biancoroyal.modbus.core.client.readModbusByFunctionCodeOne=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;n.client.readCoils(parseInt(o.payload.address),parseInt(o.payload.quantity)).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.readModbusByFunctionCodeTwo=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;n.client.readDiscreteInputs(parseInt(o.payload.address),parseInt(o.payload.quantity)).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.readModbusByFunctionCodeThree=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;n.client.readHoldingRegisters(parseInt(o.payload.address),parseInt(o.payload.quantity)).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.readModbusByFunctionCodeFour=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;n.client.readInputRegisters(parseInt(o.payload.address),parseInt(o.payload.quantity)).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.readModbusByFunctionCode=function(e,n,o,a){var t=de.biancoroyal.modbus.core.client,i=de.biancoroyal.modbus.core.client.getLogFunction(e);switch(parseInt(n.payload.fc)){case 1:t.readModbusByFunctionCodeOne(e,n,o,a);break;case 2:t.readModbusByFunctionCodeTwo(e,n,o,a);break;case 3:t.readModbusByFunctionCodeThree(e,n,o,a);break;case 4:t.readModbusByFunctionCodeFour(e,n,o,a);break;default:t.activateSendingOnFailure(e,a,new Error("Function Code Unknown"),n),i("Function Code Unknown %s",n.payload.fc)}},de.biancoroyal.modbus.core.client.readModbus=function(n,o,e,a){var t=de.biancoroyal.modbus.core.client,i=de.biancoroyal.modbus.core.client.getLogFunction(n);if(n.client){n.bufferCommands?n.queueLog(JSON.stringify({info:"read msg via Modbus",message:o.payload,queueUnitId:o.queueUnitId,timeout:n.client.getTimeout(),state:n.actualServiceState.value})):"tcp"!==n.clienttype&&n.stateService.send("READ"),n.setUnitIdFromPayload(o),n.client.setTimeout(n.clientTimeout);try{t.readModbusByFunctionCode(n,o,e,a)}catch(e){i(e.message),n.modbusErrorHandling(e),t.activateSendingOnFailure(n,a,e,o)}}else i("Client Not Ready As Object On Reading Modbus")},de.biancoroyal.modbus.core.client.writeModbusByFunctionCodeFive=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;o.payload.value?o.payload.value=!0:o.payload.value=!1,n.client.writeCoil(parseInt(o.payload.address),o.payload.value).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.writeModbusByFunctionCodeFifteen=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;parseInt(o.payload.value.length)!==parseInt(o.payload.quantity)?i.activateSendingOnFailure(n,t,new Error("Quantity should be less or equal to coil payload array length: "+o.payload.value.length+" Addr: "+o.payload.address+" Q: "+o.payload.quantity),o):n.client.writeCoils(parseInt(o.payload.address),o.payload.value).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.writeModbusByFunctionCodeSix=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;n.client.writeRegister(parseInt(o.payload.address),parseInt(o.payload.value)).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.writeModbusByFunctionCodeSixteen=function(n,o,a,t){var i=de.biancoroyal.modbus.core.client;parseInt(o.payload.value.length)!==parseInt(o.payload.quantity)?i.activateSendingOnFailure(n,t,new Error("Quantity should be less or equal to register payload array length: "+o.payload.value.length+" Addr: "+o.payload.address+" Q: "+o.payload.quantity),o):n.client.writeRegisters(parseInt(o.payload.address),o.payload.value).then(function(e){i.activateSendingOnSuccess(n,a,t,e,o)}).catch(function(e){i.activateSendingOnFailure(n,t,e,o),n.modbusErrorHandling(e)})},de.biancoroyal.modbus.core.client.writeModbus=function(n,o,e,a){var t=de.biancoroyal.modbus.core.client,i=de.biancoroyal.modbus.core.client.getLogFunction(n);if(n.client){n.bufferCommands?n.queueLog(JSON.stringify({info:"write msg",message:o.payload,queueUnitId:o.queueUnitId,timeout:n.client.getTimeout(),state:n.actualServiceState.value})):"tcp"!==n.clienttype&&n.stateService.send("WRITE"),n.setUnitIdFromPayload(o),n.client.setTimeout(n.clientTimeout);try{switch(parseInt(o.payload.fc)){case 15:t.writeModbusByFunctionCodeFifteen(n,o,e,a);break;case 5:t.writeModbusByFunctionCodeFive(n,o,e,a);break;case 16:t.writeModbusByFunctionCodeSixteen(n,o,e,a);break;case 6:t.writeModbusByFunctionCodeSix(n,o,e,a);break;default:t.activateSendingOnFailure(n,a,new Error("Function Code Unknown"),o),i("Function Code Unknown %s",o.payload.fc)}}catch(e){i(e.message),t.activateSendingOnFailure(n,a,e,o),n.modbusErrorHandling(e)}}else i("Client Not Ready As Object On Writing Modbus")},de.biancoroyal.modbus.core.client.setNewTCPNodeSettings=function(e,n){e.tcpHost=n.payload.tcpHost||e.tcpHost,e.tcpPort=n.payload.tcpPort||e.tcpPort,e.tcpType=n.payload.tcpType||e.tcpType},de.biancoroyal.modbus.core.client.setNewSerialNodeSettings=function(e,n){n.payload.serialPort&&(e.serialPort=n.payload.serialPort||e.serialPort),n.payload.serialBaudrate&&(e.serialBaudrate=parseInt(n.payload.serialBaudrate)||e.serialBaudrate),e.serialDatabits=n.payload.serialDatabits||e.serialDatabits,e.serialStopbits=n.payload.serialStopbits||e.serialStopbits,e.serialParity=n.payload.serialParity||e.serialParity,e.serialType=n.payload.serialType||e.serialType,n.payload.serialConnectionDelay&&(e.serialConnectionDelay=parseInt(n.payload.serialConnectionDelay)||e.serialConnectionDelay)},de.biancoroyal.modbus.core.client.setNewNodeOptionalSettings=function(e,n){n.payload.unitId&&(e.unit_id=parseInt(n.payload.unitId)||e.unit_id),n.payload.commandDelay&&(e.commandDelay=parseInt(n.payload.commandDelay)||e.commandDelay),n.payload.clientTimeout&&(e.clientTimeout=parseInt(n.payload.clientTimeout)||e.clientTimeout),n.payload.reconnectTimeout&&(e.reconnectTimeout=parseInt(n.payload.reconnectTimeout)||e.reconnectTimeout)},de.biancoroyal.modbus.core.client.setNewNodeSettings=function(e,n){var o=de.biancoroyal.modbus.core.client.getLogFunction(e),a=de.biancoroyal.modbus.core.client;if(!n)return o("New Connection message invalid."),!1;switch(n.payload.connectorType.toUpperCase()){case"TCP":a.setNewTCPNodeSettings(e,n),o("New Connection TCP Settings "+e.tcpHost+" "+e.tcpPort+" "+e.tcpType);break;case"SERIAL":a.setNewSerialNodeSettings(e,n),o("New Connection Serial Settings "+e.serialPort+" "+e.serialBaudrate+" "+e.serialType);break;default:o("Unknown Dynamic Reconnect Type "+n.payload.connectorType)}return a.setNewNodeOptionalSettings(e,n),!0},de.biancoroyal.modbus.core.client.messagesAllowedStates=["activated","queueing","sending","empty","connected"],module.exports=de.biancoroyal.modbus.core.client;
//# sourceMappingURL=../maps/core/modbus-client-core.js.map
